# シラバスPDFキーワード抽出スクリプト - 要件定義

## 1. 背景と課題

### 1.1 現状の問題点

現在の `scripts/extract-syllabus.js` は `pdf-parse` ライブラリを使用してPDFからテキストを抽出しているが、以下の深刻な問題が発生している。

| 問題カテゴリ           | 具体例                                                | 原因                                                                                   |
| ---------------------- | ----------------------------------------------------- | -------------------------------------------------------------------------------------- |
| **行分断（改行割れ）** | `"ステ"` + `"ークホルダ"` → 本来は `"ステークホルダ"` | PDFのカラム・段組レイアウト。pdf-parseがレイアウト座標を無視し、行単位でテキストを結合 |
| **目次情報の混入**     | `"経営・組織論 .........4"`                           | 目次ページのフィルタリング不足                                                         |
| **説明文の混入**       | `"✓ 担当業務を理解するために..."`                     | 「目標」「説明」セクションの除外ロジック不足                                           |
| **シラバス序文の混入** | `"本シラバスが…策定しましたので…"`                    | カテゴリブロック境界の誤検出                                                           |
| **不完全な括弧**       | `"バリュー）"` のみ抽出                               | 用語例内の括弧付き説明が複数行にまたがり分断                                           |
| **ノイズ文字**         | ページ番号 `"- 4 -"`、Copyright行                     | ノイズフィルタリングの不足                                                             |

### 1.2 IPAシラバスPDFの特徴

実際のPDF生テキストを分析した結果、以下の構造であることが判明。

```
◆ストラテジ系◆                        ← 系（Field）ヘッダ
大分類1：企業と法務 中分類1：企業活動   ← 大分類＋中分類ヘッダ（本文開始ページ）

1. 経営・組織論                         ← 項目番号 + 項目名
【目標】                                ← 目標セクション（不要データ）
➢ 企業活動や経営管理に関する...          ← 目標の内容（不要データ）
【説明】                                ← 説明セクション（不要データ）
✓ 担当業務を理解するために...            ← 説明の内容（不要データ）

(1) 企業活動と経営資源                   ← 小項目ヘッダ
・企業活動の目的と基本的な考え方          ← 説明文（不要データ）
用語例 経営理念，MVV，パーパス経営，...   ← ★必要データ：用語例キーワード
活用例 リーダーシップの在り方...          ← 活用例（一部必要なデータ）

- 5 -                                    ← ページ番号（不要）
Copyright(c) IPA...                     ← フッター（不要）

(2) 経営管理                             ← 次の小項目
用語例 PDCA，OODAループ，BCP，...        ← ★必要データ
```

### 1.3 テキストデータと画像データの混在

IPAシラバスPDFには以下が混在している。

- **テキストレイヤー**: 本文、用語例、活用例（大部分）
- **画像レイヤー**: 図表（「シラバスの構成」の図1など）、IPAロゴ
- **装飾要素**: チェックマーク（✓）、矢印（➢）、■マークなど

> **重要**: キーワードは全てテキストレイヤーに存在する。画像はキーワードを含まないため、OCRは不要。ただし画像の存在がテキスト抽出の座標計算を狂わせる可能性がある。

---

## 2. 利用可能なPDFライブラリの比較

### 2.1 候補ライブラリ

| ライブラリ                      | テキスト抽出 | 座標情報 | レイアウト保持 | CJK対応 | OCR | 備考                                                             |
| ------------------------------- | ------------ | -------- | -------------- | ------- | --- | ---------------------------------------------------------------- |
| **pdf-parse**                   | ○            | ✕        | ✕              | △       | ✕   | 現行使用中。シンプルだがレイアウト崩壊の原因                     |
| **pdfjs-dist** (Mozilla pdf.js) | ○            | **◎**    | ○              | ○       | ✕   | 各文字の座標・フォント情報を取得可能。レイアウト再構築に最適     |
| **pdf.js-extract**              | ○            | **◎**    | ○              | ○       | ✕   | pdfjs-distのラッパー。座標＋スタイル付きのJSON出力               |
| **MuPDF.js**                    | ○            | **◎**    | ◎              | ◎       | ✕   | 高速。構造化テキスト（Structured Text）出力対応。CJK明示サポート |
| **Tesseract.js**                | ○ (OCR)      | ○        | △              | △       | ◎   | 日本語OCR可能だが精度に課題。テキストPDFには不向き               |

### 2.2 推奨ライブラリ

**第1候補: `pdfjs-dist`（pdf.js-extract）**

理由:

1. **座標データ取得可能** → 行分断問題を「Y座標が同一の文字を結合」で解決
2. **フォント情報取得可能** → セクションヘッダ（太字・大きなフォント）の自動判別
3. **Node.js互換性が高い** → Astroプロジェクトとの親和性
4. **メンテナンス活発** → Mozillaチームによる継続的更新
5. **npmパッケージとして利用可能** → `pdf.js-extract` が簡潔なAPIを提供

**第2候補: `MuPDF.js`**

理由:

1. 構造化テキスト出力（JSON）が強力
2. CJK明示サポート（`Droid Sans Fallback Regular` フォント内蔵）
3. 高速処理
4. ただし、2025年3月リリースのv1.0で新機能のため、エコシステムの安定性が未知数

---

## 3. 要件定義

### 3.1 入力

| 項目           | 仕様                                                                               |
| -------------- | ---------------------------------------------------------------------------------- |
| 入力ファイル   | `.workspace/syllabus-data-pdf/{試験ID}/` 配下のシラバスPDF                         |
| 対応試験       | IP（ITパスポート）、SG（セキュリティマネジメント）、FE（基本情報）、AP（応用情報） |
| PDFバージョン  | IPA公式配布のシラバスPDF（Ver.6.x / 7.x など）                                     |
| マスターデータ | `src/data/master/syllabus.json`（共通構造定義）                                    |

### 3.2 出力

| 項目         | 仕様                                           |
| ------------ | ---------------------------------------------- |
| 出力ファイル | `src/data/master/syllabus-{examId}.json`       |
| 中間出力     | `.workspace/debug/` 配下にデバッグ用ファイル群 |
| フォーマット | 既存の `syllabus-ip.json` と同一のJSON構造     |

### 3.3 出力JSONスキーマ

```json
{
  "examId": "ip",
  "version": "6.5",
  "categories": [
    {
      "id": "strategy",
      "name": "ストラテジ系",
      "large_categories": [
        {
          "id": "1",
          "name": "企業と法務",
          "middle_categories": [
            {
              "id": "1",
              "name": "企業活動",
              "keywords": ["経営理念", "MVV", "パーパス経営", "..."]
            }
          ]
        }
      ]
    }
  ]
}
```

### 3.4 機能要件

#### FR-1: PDF テキスト抽出（座標付き）

- PDFの各ページからテキストアイテムを **座標情報付き** で抽出する
- 各アイテムに以下の情報を保持:
  - `text` : テキスト文字列
  - `x`, `y` : 座標（左上基準）
  - `width`, `height` : サイズ
  - `fontName` : フォント名
  - `fontSize` : フォントサイズ (オプション)
- **Y座標が近い（同一行と見なせる）テキストアイテムをX座標順に結合** → 行分断問題を解決

#### FR-2: ページ構造の自動認識

PDFテキストから以下の構造要素を自動判別する。

| 要素                 | 識別パターン                                                 | 処理                         |
| -------------------- | ------------------------------------------------------------ | ---------------------------- |
| 表紙                 | 1-3ページ目 or 「ITパスポート試験」「シラバス」を含むページ  | スキップ                     |
| 目次                 | 「目 次」ヘッダ or 点線 + ページ番号パターンが多数あるページ | スキップ                     |
| はじめに / 改訂履歴  | 「■ はじめに」「■ 改訂履歴」ヘッダ                           | スキップ                     |
| ページフッター       | `- N -` or `Copyright(c)` パターン                           | スキップ                     |
| 系ヘッダ             | `◆ストラテジ系◆` 等                                          | フィールド識別               |
| 大分類＋中分類ヘッダ | `大分類N：xxx 中分類N：xxx`                                  | カテゴリ識別                 |
| 項目ヘッダ           | `N. 項目名`（番号 + ピリオド + 名前）                        | サブセクション識別           |
| 目標 / 説明          | `【目標】` / `【説明】` / `➢` / `✓`                          | 不要データとしてスキップ     |
| 用語例               | `用語例` で始まる行 + 後続の継続行                           | **★ キーワード抽出対象**     |
| 活用例               | `活用例` で始まる行 + 後続の継続行                           | キーワード候補（設定で制御） |

#### FR-3: キーワード抽出ロジック

`用語例` セクションからキーワードを抽出する。

**Step 1: 用語例ブロックの特定**

- `用語例` という文字列で始まる行から、次の構造要素（`活用例` / `(N)` / `N.` / `【目標】`）までを1つの「ブロック」として認識

**Step 2: テキスト結合**

- ブロック内の複数行テキストを1つの文字列に結合
- 行末での単語分断を修復:
  - 行末が全角文字で終わり、次行頭が全角文字で始まる場合 → 直接結合（スペースなし）
  - 行末がアルファベットで終わり、次行頭がアルファベットで始まる場合 → スペースで結合

**Step 3: キーワード分割**

- デリミタ: `，`（全角カンマ）を主デリミタとして分割
- 最初のデリミタの前にある「`用語例`」ラベルを除去

**Step 4: キーワードクリーニング**

- 各キーワードに対して以下を実施:

| 処理                   | 例                                       | 結果                                                                         |
| ---------------------- | ---------------------------------------- | ---------------------------------------------------------------------------- |
| 前後の空白除去         | `PDCA`                                   | `PDCA`                                                                       |
| 括弧内の英語説明を保持 | `CSR（Corporate Social Responsibility）` | `CSR` にするか `CSR（Corporate Social Responsibility）` にするかは設定で制御 |
| 全角スペースの正規化   | `Human  Resource`                        | `Human Resource`                                                             |
| 「ほか」「など」の除去 | `標的型メールに関する訓練ほか`           | `標的型メールに関する訓練`                                                   |
| 空文字列の除去         |                                          | スキップ                                                                     |
| 1文字のみの除去        | `，及び` の「及び」 → 接続詞は除去       | スキップ                                                                     |

#### FR-4: 中分類へのマッピング

- 抽出したキーワードを、PDFの構造（大分類 + 中分類ヘッダ）を基にマスター定義（`syllabus.json`）の中分類IDへマッピング
- マッピングはPDFテキスト中の `中分類N：名前` パターンを検出して実行
- マッピング不可の場合はログに警告を出力

#### FR-5: デバッグ出力

抽出の各ステップの中間データをファイル出力し、問題の切り分けを容易にする。

| 出力ファイル                       | 内容                                          |
| ---------------------------------- | --------------------------------------------- |
| `debug/01_raw-items.json`          | PDFから抽出した生テキストアイテム（座標付き） |
| `debug/02_reconstructed-lines.txt` | 座標結合後の復元テキスト（行単位）            |
| `debug/03_filtered-text.txt`       | ノイズ除去後のテキスト                        |
| `debug/04_keyword-blocks.json`     | 用語例ブロック単位のテキスト                  |
| `debug/05_extracted-keywords.json` | 抽出されたキーワード一覧（カテゴリ別）        |
| `debug/06_mapping-report.txt`      | マッピング結果（成功・失敗・警告）            |

#### FR-6: 活用例キーワードのオプション抽出

- `活用例` セクションにもキーワードが含まれることがある（例: `GROWモデル`, `KPIツリー`）
- 設定フラグで活用例からも抽出するか制御可能にする
- 活用例はキーワードの密度が低い（説明文が多い）ため、追加のフィルタリングが必要

#### FR-7: 複数試験対応

- コマンドライン引数で試験IDを指定可能: `node scripts/extract-syllabus.js ip`
- 引数が一致するシラバスPDFを自動検出（`.workspace/syllabus-data-pdf/{ID}/`）
- 出力先は自動的に `src/data/master/syllabus-{examId}.json` となる

### 3.5 非機能要件

| 項目                   | 要件                                                                                |
| ---------------------- | ----------------------------------------------------------------------------------- |
| **実行環境**           | Node.js 22.x on Windows                                                             |
| **実行時間**           | 1 PDF あたり 30秒以内                                                               |
| **モジュール形式**     | ESM（`import/export`）                                                              |
| **エラーハンドリング** | PDF読み込み失敗、構造解析失敗時にわかりやすいエラーログ                             |
| **冪等性**             | 同じPDFに対して同じ出力を返す（マッピング順序含む）                                 |
| **設定外部化**         | 括弧内説明の保持/除去、活用例の抽出有無などをスクリプト冒頭の設定オブジェクトで制御 |

---

## 4. 処理フロー

```
[PDF ファイル]
     │
     ├─ (1) pdfjs-dist / pdf.js-extract で読み込み
     │       └─ テキストアイテム配列 [{text, x, y, width, height, fontName}, ...]
     │
     ├─ (2) Y座標によるテキストアイテムの行結合
     │       └─ 復元テキスト行配列 ["行1のテキスト", "行2のテキスト", ...]
     │                        ※ ここで行分断問題を解消
     │
     ├─ (3) ノイズ除去（ページフッタ、目次、表紙、はじめに、改訂履歴）
     │       └─ クリーンなテキスト行配列
     │
     ├─ (4) 構造解析（セクション分割）
     │       └─ セクションツリー:
     │           Field (系) → LargeCategory (大分類) → MiddleCategory (中分類)
     │             → Item (項目) → [用語例ブロック, 活用例ブロック]
     │
     ├─ (5) キーワード抽出
     │       └─ 用語例ブロックからデリミタ分割 + クリーニング
     │
     ├─ (6) マスター定義とのマッピング
     │       └─ syllabus.json の中分類IDとマッチング
     │
     └─ (7) JSON出力
             └─ syllabus-{examId}.json に書き出し
```

---

## 5. 技術選定まとめ

### 採用ライブラリ

```
pdf.js-extract （pdfjs-dist のラッパー）
  ├─ テキスト座標付き抽出
  ├─ フォント情報取得
  └─ Node.js ネイティブサポート
```

### npm依存

```json
{
  "devDependencies": {
    "pdf.js-extract": "^0.2.x"
  }
}
```

> **注意**: `pdf-parse` は削除しても良い（現行スクリプトの代替として新スクリプトが完成後）

---

## 6. ファイル構成

```
scripts/
  extract-syllabus-v2.js      ← 新スクリプト（メインエントリ）
  lib/
    pdf-reader.js              ← PDF読み込み＋座標付きテキスト取得
    line-reconstructor.js      ← Y座標ベースの行復元
    structure-parser.js        ← セクション構造解析
    keyword-extractor.js       ← キーワード抽出＋クリーニング
    syllabus-mapper.js         ← マスター定義マッピング
    config.js                  ← 設定の外部化

.workspace/
  debug/                       ← デバッグ出力ディレクトリ（gitignore推奨）
```

---

## 7. リスクと対策

| リスク                                       | 影響               | 対策                                                      |
| -------------------------------------------- | ------------------ | --------------------------------------------------------- |
| `pdfjs-dist` が Node22 で動かない            | 開発ブロック       | `MuPDF.js` をバックアップ候補として検証                   |
| 試験ごとにPDF構造が異なる                    | マッピング失敗     | 構造パターンを設定ファイルで柔軟に定義                    |
| 用語例内に「，」以外のデリミタが使われている | キーワード分割失敗 | 生データ分析で確認済み → `，`（全角カンマ）が統一デリミタ |
| ページまたぎの用語例ブロック                 | ブロック途中の分断 | ページ結合後にセクション解析を実行                        |
| 活用例の中にしか記載されないキーワードがある | キーワード漏れ     | FR-6 でオプション対応                                     |

---

## 8. 実装優先度

### Phase 1（MVP）

- [x] FR-1: PDF テキスト抽出（座標付き）
- [x] FR-2: ページ構造の自動認識
- [x] FR-3: キーワード抽出ロジック
- [x] FR-4: 中分類へのマッピング
- [x] FR-5: デバッグ出力（最低限 02, 05, 06）

### Phase 2（機能拡張）

- [ ] FR-6: 活用例キーワードのオプション抽出
- [ ] FR-7: 複数試験対応（IP以外）
- [ ] SyllabusParser.tsx（WebUI）との連携改善

### Phase 3（品質改善）

- [ ] 抽出結果の自動バリデーション（マスター定義との照合）
- [ ] 抽出結果の diff 表示（前回抽出結果との比較）
- [ ] CI/CDパイプラインでの自動実行

---

## 9. 確認事項（実装前にユーザーに確認）

1. **括弧内の英語説明をどうするか？**
   - 例: `CSR（Corporate Social Responsibility）`
   - A) 日本語キーワードのみ残す → `CSR`
   - B) 括弧説明も含めて保持 → `CSR（Corporate Social Responsibility）`
   - C) 日本語名と略語を分離 → `["CSR", "Corporate Social Responsibility"]`

2. **活用例からもキーワードを抽出するか？**
   - 活用例には `GROWモデル`、`KPIツリー` など有用なキーワードがあるが、文章が多いためノイズリスクあり

3. **既存の手動クリーン済み `syllabus-ip.json` との関係は？**
   - A) 新スクリプトの結果で上書き
   - B) 新スクリプトの結果と手動版を比較して差分のみ更新
   - C) 手動版をベースに、新スクリプトは他の試験（SG, FE, AP）のみ対象

4. **新スクリプトのファイル名は？**
   - 提案: `scripts/extract-syllabus-v2.js`（旧版と共存）
